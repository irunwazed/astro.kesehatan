---
import Layout from "../layouts/Layout.astro";
---

<Layout>
    <div
        class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-green-50 px-4"
    >
        <div
            class="bg-white/90 backdrop-blur-md shadow-xl rounded-2xl w-full max-w-md p-8 border border-gray-100"
        >
            <!-- Logo / Header -->
            <div class="text-center mb-8">
                <!-- <div class="flex justify-center mb-3">
          <img src="/logo-health.svg" alt="Health Research Logo" class="w-14 h-14" />
        </div> -->
                <h2
                    class="text-3xl font-bold text-gray-800 tracking-tight mt-4"
                >
                    Portal Penelitian RSABHK
                </h2>
                <p class="text-gray-500 mt-2 text-sm">
                    Silakan masuk untuk mengakses data penelitian ðŸ§¬
                </p>
            </div>

            <!-- Form -->
            <form class="space-y-6">
                <!-- Email -->
                <div>
                    <label
                        for="email"
                        class="block text-sm font-medium text-gray-700 mb-1"
                        >Email</label
                    >
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition"
                        placeholder="contoh@email.com"
                    />
                </div>

                <!-- Password -->
                <div>
                    <label
                        for="password"
                        class="block text-sm font-medium text-gray-700 mb-1"
                        >Password</label
                    >
                    <input
                        type="password"
                        id="password"
                        name="password"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition"
                        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                    />
                </div>

                <!-- Tombol Login -->
                <button
                    type="submit"
                    class="w-full bg-gradient-to-r from-blue-500 to-green-500 text-white py-2.5 rounded-lg font-semibold hover:from-blue-600 hover:to-green-600 transition-all shadow-sm hover:shadow-md"
                >
                    Masuk ke Akun
                </button>
            </form>

            <!-- Divider -->
            <div class="mt-6 text-center text-gray-500 text-sm">
                Belum punya akun?
                <a href="/register" class="text-blue-600 hover:underline">
                    Daftar Sekarang
                </a>
            </div>

            <!-- Footer -->
            <p class="mt-8 text-xs text-center text-gray-400">
                Â© {new Date().getFullYear()} Lembaga Penelitian RSABHK. All rights
                reserved.
            </p>
        </div>
    </div>

    <script>
        import { route } from "src/helpers/lib/route";
        import { setCookie } from "src/helpers/lib/storage";

        interface LoginResponse {
            message?: string;
            access_token?: string;
            expires_in?: number;
            expires_at?: number;
            user?: {
                email?: string;
                user_metadata: {
                    full_name: string;
                    roles: string[];
                };
            };
        }

        function isLoading(status: boolean): void {
            const overlay = document.getElementById(
                "loading-overlay",
            ) as HTMLDivElement;
            overlay.classList.toggle("hidden", !status);
        }

        async function loginUser(event: Event): Promise<void> {
            event.preventDefault();

            const emailInput =
                document.querySelector<HTMLInputElement>("#email");
            const passwordInput =
                document.querySelector<HTMLInputElement>("#password");

            if (!emailInput || !passwordInput) {
                alert("Elemen input email atau password tidak ditemukan!");
                return;
            }

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                alert("Email dan password harus diisi!");
                return;
            }
            isLoading(true);
            try {
                const response = await fetch("/api/login", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ email, password }),
                });

                const result: { data: LoginResponse; message: string } =
                    await response.json();

                if (response.ok) {
                    alert(
                        `âœ… Login berhasil! Selamat datang, ${
                            result.data.user?.email ?? "peneliti"
                        }`,
                    );
                    setCookie(
                        "token",
                        result.data.access_token ?? "",
                        result.data.expires_in,
                    );
                    route.push("/app");
                } else {
                    alert(
                        `âŒ Gagal login: ${result?.message ?? "Email atau password salah"}`,
                    );
                }
            } catch (error) {
                console.error("Login error:", error);
                alert("Terjadi kesalahan saat menghubungi server.");
            } finally {
                isLoading(false);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const form = document.querySelector<HTMLFormElement>("form");
            if (form) {
                form.addEventListener("submit", loginUser);
            }
        });
    </script>
</Layout>
